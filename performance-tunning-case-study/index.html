<!DOCTYPE html>
<html>
    <head>
      <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>Performance tunning case study</title>
<meta name="viewport" content="width=device-width">
<link rel="shortcut icon" href="favicon.ico" type="image/vnd.microsoft.icon" />
<!-- syntax highlighting CSS -->
<!--link rel="stylesheet" href="/css/syntax.css"-->

<!-- Custom CSS -->
<link rel="stylesheet" href="/assets/application-1070e5396a9f348b2c31565a8ca2ade6.css">

<!-- Custom JS -->
<script src="/assets/vendor/jquery-2.1.1-fbf0c31ef61d80bbbc98a9cdfc7e6632.js"></script>
<script src="/assets/vendor/jquery.validate-466ee815d7a2fb9b74b895b6a0f9551c.js"></script>
<script src="/assets/vendor/scrollup/jquery.scrollUp-d730604bacd24a59da00d38b42cd77af.js"></script>
<script src="/assets/vendor/drupal_legacy-d5580e3eaf6de5a1446255d180dc73d3.js"></script>
<script src="/assets/vendor/angular.min-dfd2efe0eaac3581c5faf5cfed3b159e.js"></script>
<script src="/assets/meetup_events-5782f731b79266fd93b159cb798cc3d5.js"></script>
<script src="/assets/contact-897905f16738b8c5c1688eefae319441.js"></script>
<script src="/assets/application-07f972327fcb4602f91f1e8ba4b78498.js"></script>

<!-- ShareThis JS for posts section -->
<script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
<script type="text/javascript">stLight.options({publisher: "6ae64a50-63a5-4021-a8de-b0adce0ce99b", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    </head>

    <body class="one-sidebar sidebar-second section-jsandroidjavarubydevops page-node node-type-article all-pages with-navigation with-subnav featured dir-ltr">
        <div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&appId=519865898033052&version=v2.0";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
        <div id="header-first">
  <div class="region region-header-first">
    <div id="block-search-form" class="block block-search block-odd">

      <div class="content">
        <form id="search-block-form" accept-charset="UTF-8"><div><div class="container-inline">
              <h2 class="element-invisible">Search form</h2>
              <div class="form-item form-type-textfield form-item-search-block-form">
                <label class="element-invisible" for="edit-search-block-form--2">Search </label>
                <input title="Enter the terms you wish to search for." placeholder="Search" type="search" id="edit-search-block-form--2" name="search_block_form" value="" size="15" maxlength="128" class="form-text">
              </div>
              <div class="form-actions form-wrapper" id="edit-actions"><input type="submit" id="edit-submit" name="op" value="Search" class="form-submit"></div><input type="hidden" name="form_build_id" value="form-hCEJ23kB0sHlr4dB3Yv5-2cDcH10yNwGSUn69WjCjF4">
              <input type="hidden" name="form_id" value="search_block_form">
            </div>
      </div></form>  </div><!-- /.content -->
    </div><!-- /.block -->
    <div id="block-menu-menu-top-links" class="block block-menu block-even">

      <div class="content">
        <ul class="menu clearfix"><li class="first last leaf login"><a href="/user" title="">login</a></li>
      </ul>  </div><!-- /.content -->
    </div><!-- /.block -->
    <div id="block-menu-menu-language" class="block block-menu block-odd">
      
      <div class="content">
        <ul class="menu clearfix"><li class="first last leaf עברית"><a href="/hebrew" title="">עברית</a></li>
      </ul>  </div><!-- /.content -->
    </div><!-- /.block -->
  </div>
</div>
<div id="google-search-form" style="visibility:hidden; width: 1px; height: 1px; float:right;">
  <script>

    (function() {
        var cx = '012617499894110201007:qu0yvmmzksu';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = false;
        gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
                '//www.google.com/cse/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
    })();
</script>
<gcse:searchresults-only linkTarget="_self"></gcse:searchresults-only>


<script>
    $(document).ready(function() {
        $('#search-block-form').submit(function (e) {
            e.preventDefault();

            //find google search form
            var form = $('.gsc-control-wrapper-cse').find('form');
            var input = form.find("input[name='search']");
            var btn = form.find("input[type='image']");
            var tikalSearch = $('#edit-search-block-form--2');
            tikalSearch.blur();
            $("#bg").show();
            input.val(tikalSearch.val());
            //form.submit();
            btn.click();

        });
        
    });


</script>

</div>

        <header id="header" role="banner">
  <div class="logo-and-region-header">
    <div class="background-logo"></div>
    <a href="/" title="Home" rel="home" id="logo">
      <img src="/assets/logo-ebc269c722e9e1e11b3252c442c75750.png" alt="Home">
    </a>


    <div class="region region-header">
      <section id="block-menu-menu-header-menu" class="block block-menu block-even">
        <h2 class="block-title element-invisible">Header menu</h2>

        <div class="content">
          <ul class="menu clearfix">
            
              
              <li class="leaf"><a href="/about" class="">About</a></li>
            
              
              <li class="leaf"><a href="/solutions" class="">Solutions</a></li>
            
              
              <li class="leaf"><a href="/careers" class="">Careers</a></li>
            
              
              <li class="leaf"><a href="/events" class="">Events</a></li>
            
              
              <li class="leaf"><a href="/contact" class="">Contact</a></li>
            
        </ul>  </div><!-- /.content -->
      </section><!-- /.block -->
      <section id="block-menu-menu-domains" class="block block-menu block-odd">
        <h2 class="block-title element-invisible">Domains</h2>

        <div class="content">
          <ul class="menu clearfix"><li class="first leaf devops"><a href="/devops" title="">DevOps</a></li>
            <li class="leaf java"><a href="/java" title="">JAVA</a></li>
            <li class="leaf js"><a href="/js" title="">JS</a></li>
            <li class="leaf android"><a href="/android" title="">Android</a></li>
            <li class="last leaf ruby"><a href="/ruby" title="">Ruby</a></li>
        </ul>  </div><!-- /.content -->
      </section><!-- /.block -->
    </div>
  </div><!-- /#logo-and-region-header -->
</header>

        <div class="featured-background">
  <div id="featured">
    <div class="region-title-and-featured">
      <h1 class="title" id="page-title">Performance tunning case study</h1>
      <div class="region region-featured">
        <div id="block-views-author-block" class="block block-views">
          <div class="content">
            <div class="view view-author view-id-author view-display-id-block">
  <div class="view-content">
    <div class="view-content-limit">
      <div class="view-content-limit-content">
        <div class="views-row">
          <div class="views-field views-field-picture">
            <div class="field-content">
              
                <img src="/assets/pictures/profile-default-ab65955ebe8cf05005dc2e1ae497d862.jpg" width="307" height="230" alt="">
              
            </div>  
          </div>
          <div class="views-field views-field-field-first-name">
            <div class="field-content"></div>
          </div>
          <div class="views-field views-field-field-last-name">
            <div class="field-content"></div>
          </div>
          <div class="views-field views-field-field-description">
            <div class="field-content"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

        <div class="shadow-page"></div>
        <div id="page">
          <div id="main">
            <div class="region region-content">
              <div id="block-system-main" class="block block-system">
                <div class="content">
                  <article class="node node-article published with-comments node-full">
                    <header>
  <div class="by-and-tags">
    <div class="by">
      <div class="label-by">by</div>
      <div class="name">
        
      </div>
    </div>
    <div class="tags">
      <div class="label-tags">tags:</div>
      <div class="float-tags">
        <div class="field field-name-field-tags field-type-taxonomy-term-reference field-label-hidden clearfix">
          <ul class="links">
            
              <li>
                <a href="/tags/JAVA">JAVA</a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
  <time pubdate="" datetime="2009-06-03 00:00:00 +0300">
        <div class="day">03</div>
        Jun. 2009
      </time>
  
  
  


<span class="share-buttons">
  <span st_url='http://tikalk.com/performance-tunning-case-study' st_title='Performance tunning case study' class='st_facebook_hcount' displayText='Facebook'></span>
  <span st_url='http://tikalk.com/performance-tunning-case-study' st_title='Performance tunning case study' class='st_linkedin_hcount' displayText='LinkedIn'></span>
  <span st_url='http://tikalk.com/performance-tunning-case-study' st_title='Performance tunning case study' class='st_twitter_hcount' displayText='Tweet'></span>
  <span st_url='http://tikalk.com/performance-tunning-case-study' st_title='Performance tunning case study' class='st_fblike_hcount' displayText='Facebook Like'></span>
  <span st_url='http://tikalk.com/performance-tunning-case-study' st_title='Performance tunning case study' class='st_plusone_hcount' displayText='Google +1'></span>
</span>
</header>

                    <p>Recently I had the chance to help one of our clients (company XXX) analyze and detect performance issues. Below are the main issues raised during the consultation session and the recommended course of action for each problem. I am presenting these here for the benefit of other employees who might be needed to do the same type of consulting.</p>

<p><br />
<strong>General background:</strong> company XXX reported several problems, mainly related to high memory consumption and thread exhaustion, with respect to their product at one of their largest clients web site.</p>

<p><br />
Hardware: company XXX runs a 64bit machine with eight cores, equipped with 32GB of physical RAM (I have not collected data about the actual OS swap configurations, they might or might not be optimal).<br />
<br />
Software: The OS is Red-hat Linux, the Jvm is 1.5.10, HTTP server is Apache 2,the application server is JBoss 4.01, the servlet container is Tomcat, the database is mostly an in-memory Oracle server.<br />
<br />
Reported issues: There seemed to be an issue with this version of the JDK's jmap command (for generating memory dumps)<br />
Findings:jmap hanged while inspecting the JVM, there with a cryptic output which could not be really understood.<br />
Action items: consider upgrading to the latest JDK 5 release (I have version 1.5.1.15, tested on a dual core Linux machine with no problems)<br />
Alternative course of action: Run the UNIX command : kill -3 &lt;pid&gt; to generate a memory dump. OR run the JVM with the HPROF agent on (java -agentlib:hprof) and then kill the process from the command line, this will generate the memory dump on the local dir (default is text mode). Note that this will considerably slow down your JVM process and is not suitable for production use. OR run jstat for several minutes to monitor the JVM heap and GC trends on the fly (excellent option which does not slow down the JVM)<br />
The memory heap dumps generated by these tools should be viewable with the HAT utility or the VisualVM utility (shipped with JDK 1.6)<br />
&nbsp;<br />
Server configuration:&nbsp; <br />
Apache is currently the HTTP front end and uses mod_jk to connect to Jboss,<br />
JBoss also connects to an RMI server slice and hence uses distributed garbage collection. Currently, there are 4 JVMs running on this machine. namely they are (the list may be viewed any time by running the command &quot;jps&quot;):<br />
Jboss instance,<br />
RMI instance (or slice ...)<br />
Agent<br />
Unknown java application which belongs to&nbsp; company XXX.<br />
Reported issues:There were issues with the maximum number of threads running on both Tomcat and Apache. One issue was resolved (according to company XXX this had to do with blocking on a Thread), but there are still problems with the Apache threads. Additionally, they reported an issue with a bulk of multiple HTTP requests emerging from the same IP which resulted in a server crash (this was logged on the apache error log). In addition, they reported having a very large Java Heap size while inspecting the process using the Linux TOP command. Another issue raised was related to the use of the standard java HashSet for populating 4 million records in memory on the fly. company XXX suspected that there might be memory leak in the program.<br />
Findings:<br />
Apache: there is no distinction between dynamic and static requests, no cache is configured (such as mode_cache), thread and process configurations are sub optimal for a multi core CPU.<br />
JBoss: Jboss uses Hibernate to connect to the Oracle DB however NO entity cache and NO collections cache are used ASFAIK, and coincidentally, JDBC connection pool with default pool size (20) is used.<br />
The JVM parameters are sub optimal, a setting for max heap size of 6GB is set, but no initial heap size is set, a setting for the permanent generation heap is set, but no initial permanent generation is set.In addition, there is no setting for the new generation heap and the default is used. On the endorsed classpth, there are JARs written by company XXX which might use JNI. Similar settings are used for the RMI slice machine. The garbage collector thread on the JBoss instance runs every minute resulting in full garbage collection.&nbsp;&nbsp; <br />
HashSet issue:with a modest 512mb heap size, and 4 million recoreds, the JVM crashed on OOM error.<br />
Action items:<br />
Apache: I would start by tweaking the thread and process configurations of apache and tomcat in tandem. An excellent starting point is: http://kbase.redhat.com/faq/docs/DOC-15866;jsessionid=2D230676993736AA36152A795BBC6209.066ef7ba<br />
There is also a distinction between the Apache prefork and Apache worker modules which has to be taken into consideration (see http://www.camelrichard.org/apache-prefork-vs-worker). I would suggest testing the current state of Apache using the outstanding AB tool (apache benchmark, available on every Linux machine) in a sterile environment and then start the tweaking until an optimal performance is gained.&nbsp; The separation of static and dynamic content and the cache configurations are IMOH minor at the moment.<br />
Jboss:<br />
Enable entity and collection cache using EhCache (non distributed cache). This has to be a long term action item.&nbsp; Increase the number of JDBC connections to 50 or 100, I suspect 20 is very low for such a high end machine. Note however that each JDBC connection will allocate approximatly 1MB of heap space on the stack.&nbsp; <br />
As a starting point, alter the jvm parammeters as follows:<br />
-Xms3600m -Xmx3600m -XX:PermSize=512m -XX:MaxPermSize=512m -XX:NewSize=768m -XX:MaxNewSize=768m<br />
With respect to the company XXX jars on the endored dir ( i think there are 3 such jars), make sure they are NOT using JNI.To avoid the full garbage collection resulting from the RMI registeri, increase the GC interval to10 or 15 minutes and test again. company XXX reported they had previously done that on the RMI slice and had benefited performance wise.<br />
<br />
HashSet issue:<br />
using a small java program, I tested the regular HashSet, a generic HashSet &lt;String&gt;, a generic java.util.concurent.HashMap and a simple generic ArrayList&lt;String&gt;. My conclusion is that there is no memory issue at all, 4 million&nbsp; String records loaded into memory SHOULD generate an OOM error on a small heap.<br />
<br />
Final summary:<br />
Inspection of the JVM using jstat, jprofiler and jconsole prooved that the JVM parameters were sub optiomal with the process spending a lot of time on GC. The statistics showed<br />
that there wasn't much space left on the &quot;young generation&quot; heap even with a relative allocation of 756MB. In addition, even with 15 connected users the&nbsp; &quot;old generation&quot; heap reached its maximum (5GB) in 5 minutes. The application seemed to just consume as much memory as it can however without producing an OOM error. Jprofiler showed several problems in the code allocating 600K char[] however they were not willing to inspect that further. The folowing JVM parameters are the ones that are used after several hours of tweaking and testing:<br />
<br />
XX:PermSize=512m -Xms5g -Xmx5g -XX:NewSize=756m -XX:MaxNewSize=756m -XX:SurvivorRatio=6 -XX:GCTimeRatio=2 -XX:ParallelGCThreads=8 -XX:+UseParNewGC -XX:MaxGCPauseMillis=2000 -XX:+DisableExplicitGC<br />
<br />
&nbsp;</p>

                    <div class="fb-comments" data-href="http://tikalk.com/performance-tunning-case-study" data-width="600px" data-numposts="5" data-colorscheme="light"></div>
                    <footer></footer>
                  </article>
                </div>
              </div>
            </div>
          </div>
        </div>
        <footer id="footer" role="contentinfo">
  <div class="region region-footer">
    <section id="block-block-2" class="block block-block block-about-tikal block-even">
      <h2 class="block-title">About Tikal</h2>

      <div class="content">
        <div>
          <div>
            For over 12 years, we have helped breakthrough companies achieve excellence and meet their goals.&nbsp;</div>
          <div>
            By doing so we've earned recognition for delivering extremely competitive and high-performance software services to clients worldwide.</div>
        </div>
        <div class="contact-title">
          Contact Information</div>
        <div class="contact-number">
          (972) 3 6488618</div>
        <div class="contact-mail">
          <a href="">info@tikalk.com</a></div>
      </div><!-- /.content -->
    </section><!-- /.block -->
    <section id="block-webform-client-block-22" class="block block-webform join-the-team block-odd">
      <h2 class="block-title">Join the Team</h2>
      <div class="content">
        <div>
          <div class="form-item webform-component webform-component-markup" id="webform-component-sub-header">
              <p>Let us contact you with more information</p>
          </div>
          <script type="text/javascript" src="http://form.jotform.me/jsform/41884289305463"></script>
        </div>
      </div><!-- /.content -->
    </section><!-- /.block -->
    <section id="block-general-tikal-map-home-page" class="block block-general-tikal block-even">
      <h2 class="block-title">Find us at:</h2>

      <div class="content">

        <div id="map_canvas_footer" style="width: 240px; height: 200px;"></div>
        <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
        <script type="text/javascript">
            var latlng = new google.maps.LatLng(32.1065469,34.83523969999999);
            var settings = {
            zoom: 15,
                  center: latlng,
                  mapTypeControl: false,
                  mapTypeControlOptions: {style: google.maps.MapTypeControlStyle.DROPDOWN_MENU},
                  navigationControlOptions: {style: google.maps.NavigationControlStyle.SMALL},
                  mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            var map = new google.maps.Map(document.getElementById("map_canvas_footer"), settings);      
            var companyImage = new google.maps.MarkerImage("/assets/icons/logo-map-1a2609d2dd636172949b30cd33a1d8a0.png",
                new google.maps.Size(100,50),
                new google.maps.Point(0,0),
                new google.maps.Point(50,50)
            );
            var companyShadow = new google.maps.MarkerImage("images/logo_shadow.png",
                new google.maps.Size(130,50),
                new google.maps.Point(0,0),
                new google.maps.Point(65, 50)
            );
            var companyPos = new google.maps.LatLng(32.1065469,34.83523969999999);
            var companyMarker = new google.maps.Marker({
              position: companyPos,
              map: map,
              icon: companyImage,
              shadow: companyShadow,
              title:"",
              zIndex: 3}
            );
        </script>  
      </div><!-- /.content -->
    </section><!-- /.block -->
    <div id="block-block-3" class="block block-block find-us-at block-odd">
      <div class="content">
        <div class="address">
          Habarzel 4 st, 1st Floor&nbsp;<br>
          Tel Aviv 69710<br>
          Israel
        </div>  
      </div><!-- /.content -->
    </div><!-- /.block -->
  </div>
</footer>

        <footer id="footer-second" role="contentinfo">
  <div class="region region-footer-second">
    <section id="block-views-popular-articles-block" class="block block-views block-even">
      <h2 class="block-title">Popular Articles</h2>

      <div class="content">
        <div class="view view-popular-articles view-id-popular_articles view-display-id-block view-dom-id-796319b1b70c397287cdccd16eebbb82">

          <div class="view-content">
            <div class="view-content-limit">
              <div class="view-content-limit-content">
                <div class="views-row views-row-1 views-row-odd views-row-first">

                  <div class="views-field views-field-title">        <span class="field-content"><a href="/java/location-auto-complete-and-lookup">Location Auto complete and lookup</a></span>  </div>  </div>
                <div class="views-row views-row-2 views-row-even">

                  <div class="views-field views-field-title">        <span class="field-content"><a href="/js/present-and-future-typescript">Present and future of TypeScript</a></span>  </div>  </div>
                <div class="views-row views-row-3 views-row-odd views-row-last">

                  <div class="views-field views-field-title">        <span class="field-content"><a href="/ror/building-gogobot-social-graph">building the gogobot social graph</a></span>  </div>  </div>
              </div>
            </div>
          </div>

      </div>  </div><!-- /.content -->
    </section><!-- /.block -->
    <section id="block-menu-menu-fields" class="block block-menu block-odd">
      <h2 class="block-title">Domains</h2>

      <div class="content">
        <ul class="menu clearfix"><li class="first leaf application lifecycle management"><a href="/alm" title="">DevOps</a></li>
          <li class="leaf java"><a href="/java" title="">Java</a></li>
          <li class="leaf javascript"><a href="/js" title="">JavaScript</a></li>
          <li class="leaf .net"><a href="/net" title="">Android</a></li>
          <li class="last leaf ruby on rails"><a href="/ror" title="">Ruby</a></li>
      </ul>  </div><!-- /.content -->
    </section><!-- /.block -->
    <section id="block-menu-menu-site-map" class="block block-menu block-even">
      <h2 class="block-title">Site Map</h2>

      <div class="content">
        <ul class="menu clearfix"><li class="first leaf about us"><a href="/about" title="">About Us</a></li>
          <li class="leaf active-trail solutions"><a href="/solutions" title="" class="active-trail active">Solutions</a></li>
          <li class="leaf careers"><a href="/careers" title="">Careers</a></li>
          <li class="leaf events"><a href="/events" title="">Events</a></li>
          <li class="last leaf contact"><a href="/contact" title="">Contact</a></li>
      </ul>  </div><!-- /.content -->
    </section><!-- /.block -->
    <div id="block-block-1" class="block block-block all-rights-reserved block-odd">

      <div class="content">
        <p>© 2013 All Rights Reserved. Tikal</p>
      </div><!-- /.content -->
    </div><!-- /.block -->
    <div id="block-menu-menu-external-links" class="block block-menu block-even">

      <div class="content">
        <ul class="menu clearfix"><li class="first leaf facebook"><a href="http://www.facebook.com/TikalKnowledge" title="" target="_blank">Facebook</a></li>
          <li class="leaf twitter"><a href="https://twitter.com/TikalK" title="" target="_blank">Twitter</a></li>
          <li class="leaf in"><a href="http://www.linkedin.com/company/tikal-knowledge" title="" target="_blank">in</a></li>
          <li class="last leaf rss"><a href="/rss-latest-articles" title="Latest Articles">RSS</a></li>
      </ul>  </div><!-- /.content -->
    </div><!-- /.block -->
  </div>
</footer>

    </body>
</html>
