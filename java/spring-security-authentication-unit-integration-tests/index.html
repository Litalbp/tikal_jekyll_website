<!DOCTYPE html>
<html>
    <head>
      <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>Spring Security Authentication in Unit / Integration tests</title>
<meta name="viewport" content="width=device-width">
<link rel="shortcut icon" href="favicon.ico" type="image/vnd.microsoft.icon" />
<!-- syntax highlighting CSS -->
<!--link rel="stylesheet" href="/css/syntax.css"-->

<!-- Custom CSS -->
<link rel="stylesheet" href="/assets/application-1070e5396a9f348b2c31565a8ca2ade6.css">

<!-- Custom JS -->
<script src="/assets/vendor/jquery-2.1.1-fbf0c31ef61d80bbbc98a9cdfc7e6632.js"></script>
<script src="/assets/vendor/jquery.validate-466ee815d7a2fb9b74b895b6a0f9551c.js"></script>
<script src="/assets/vendor/scrollup/jquery.scrollUp-d730604bacd24a59da00d38b42cd77af.js"></script>
<script src="/assets/vendor/drupal_legacy-d5580e3eaf6de5a1446255d180dc73d3.js"></script>
<script src="/assets/vendor/angular.min-dfd2efe0eaac3581c5faf5cfed3b159e.js"></script>
<script src="/assets/meetup_events-5782f731b79266fd93b159cb798cc3d5.js"></script>
<script src="/assets/contact-897905f16738b8c5c1688eefae319441.js"></script>
<script src="/assets/application-07f972327fcb4602f91f1e8ba4b78498.js"></script>

<!-- ShareThis JS for posts section -->
<script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
<script type="text/javascript">stLight.options({publisher: "6ae64a50-63a5-4021-a8de-b0adce0ce99b", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    </head>

    <body class="one-sidebar sidebar-second section-java page-node node-type-article all-pages with-navigation with-subnav featured dir-ltr">
        <div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&appId=519865898033052&version=v2.0";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
        <div id="header-first">
  <div class="region region-header-first">
    <div id="block-search-form" class="block block-search block-odd">

      <div class="content">
        <form id="search-block-form" accept-charset="UTF-8"><div><div class="container-inline">
              <h2 class="element-invisible">Search form</h2>
              <div class="form-item form-type-textfield form-item-search-block-form">
                <label class="element-invisible" for="edit-search-block-form--2">Search </label>
                <input title="Enter the terms you wish to search for." placeholder="Search" type="search" id="edit-search-block-form--2" name="search_block_form" value="" size="15" maxlength="128" class="form-text">
              </div>
              <div class="form-actions form-wrapper" id="edit-actions"><input type="submit" id="edit-submit" name="op" value="Search" class="form-submit"></div><input type="hidden" name="form_build_id" value="form-hCEJ23kB0sHlr4dB3Yv5-2cDcH10yNwGSUn69WjCjF4">
              <input type="hidden" name="form_id" value="search_block_form">
            </div>
      </div></form>  </div><!-- /.content -->
    </div><!-- /.block -->
    <div id="block-menu-menu-top-links" class="block block-menu block-even">

      <div class="content">
        <ul class="menu clearfix"><li class="first last leaf login"><a href="/user" title="">login</a></li>
      </ul>  </div><!-- /.content -->
    </div><!-- /.block -->
    <div id="block-menu-menu-language" class="block block-menu block-odd">
      
      <div class="content">
        <ul class="menu clearfix"><li class="first last leaf עברית"><a href="/hebrew" title="">עברית</a></li>
      </ul>  </div><!-- /.content -->
    </div><!-- /.block -->
  </div>
</div>
<div id="google-search-form" style="visibility:hidden; width: 1px; height: 1px; float:right;">
  <script>

    (function() {
        var cx = '012617499894110201007:qu0yvmmzksu';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = false;
        gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
                '//www.google.com/cse/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
    })();
</script>
<gcse:searchresults-only linkTarget="_self"></gcse:searchresults-only>


<script>
    $(document).ready(function() {
        $('#search-block-form').submit(function (e) {
            e.preventDefault();

            //find google search form
            var form = $('.gsc-control-wrapper-cse').find('form');
            var input = form.find("input[name='search']");
            var btn = form.find("input[type='image']");
            var tikalSearch = $('#edit-search-block-form--2');
            tikalSearch.blur();
            $("#bg").show();
            input.val(tikalSearch.val());
            //form.submit();
            btn.click();

        });
        
    });


</script>

</div>

        <header id="header" role="banner">
  <div class="logo-and-region-header">
    <div class="background-logo"></div>
    <a href="/" title="Home" rel="home" id="logo">
      <img src="/assets/logo-ebc269c722e9e1e11b3252c442c75750.png" alt="Home">
    </a>


    <div class="region region-header">
      <section id="block-menu-menu-header-menu" class="block block-menu block-even">
        <h2 class="block-title element-invisible">Header menu</h2>

        <div class="content">
          <ul class="menu clearfix">
            
              
              <li class="leaf"><a href="/about" class="">About</a></li>
            
              
              <li class="leaf"><a href="/solutions" class="">Solutions</a></li>
            
              
              <li class="leaf"><a href="/careers" class="">Careers</a></li>
            
              
              <li class="leaf"><a href="/events" class="">Events</a></li>
            
              
              <li class="leaf"><a href="/contact" class="">Contact</a></li>
            
        </ul>  </div><!-- /.content -->
      </section><!-- /.block -->
      <section id="block-menu-menu-domains" class="block block-menu block-odd">
        <h2 class="block-title element-invisible">Domains</h2>

        <div class="content">
          <ul class="menu clearfix"><li class="first leaf devops"><a href="/devops" title="">DevOps</a></li>
            <li class="leaf java"><a href="/java" title="">JAVA</a></li>
            <li class="leaf js"><a href="/js" title="">JS</a></li>
            <li class="leaf android"><a href="/android" title="">Android</a></li>
            <li class="last leaf ruby"><a href="/ruby" title="">Ruby</a></li>
        </ul>  </div><!-- /.content -->
      </section><!-- /.block -->
    </div>
  </div><!-- /#logo-and-region-header -->
</header>

        <div class="featured-background">
  <div id="featured">
    <div class="region-title-and-featured">
      <h1 class="title" id="page-title">Spring Security Authentication in Unit / Integration tests</h1>
      <div class="region region-featured">
        <div id="block-views-author-block" class="block block-views">
          <div class="content">
            <div class="view view-author view-id-author view-display-id-block">
  <div class="view-content">
    <div class="view-content-limit">
      <div class="view-content-limit-content">
        <div class="views-row">
          <div class="views-field views-field-picture">
            <div class="field-content">
              
                <img typeof="foaf:Image" src="/assets/pictures/picture-95-1361373746-6c5cf91ff7f30398949b334e4b38baf0.jpg" width="307" height="230" alt="">
              
            </div>  
          </div>
          <div class="views-field views-field-field-first-name">
            <div class="field-content">Ori</div>
          </div>
          <div class="views-field views-field-field-last-name">
            <div class="field-content">Segal</div>
          </div>
          <div class="views-field views-field-field-description">
            <div class="field-content">Sr. Flex Developer</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

        <div class="shadow-page"></div>
        <div id="page">
          <div id="main">
            <div class="region region-content">
              <div id="block-system-main" class="block block-system">
                <div class="content">
                  <article class="node node-article published with-comments node-full">
                    <header>
  <div class="by-and-tags">
    <div class="by">
      <div class="label-by">by</div>
      <div class="name">
        <a href='/js/ori'>ori</a>
      </div>
    </div>
    <div class="tags">
      <div class="label-tags">tags:</div>
      <div class="float-tags">
        <div class="field field-name-field-tags field-type-taxonomy-term-reference field-label-hidden clearfix">
          <ul class="links">
            
              <li>
                <a href="/tags/JAVA">JAVA</a>
              </li>
            
              <li>
                <a href="/tags/Spring-Security-Integration-tests-Spring-TestContext-Framework">Spring Security Integration tests Spring TestContext Framework</a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
  <time pubdate="" datetime="2011-06-04 00:00:00 +0300">
        <div class="day">04</div>
        Jun. 2011
      </time>
  
  
  


<span class="share-buttons">
  <span st_url='http://tikalk.com/java/spring-security-authentication-unit-integration-tests' st_title='Spring Security Authentication in Unit / Integration tests' class='st_facebook_hcount' displayText='Facebook'></span>
  <span st_url='http://tikalk.com/java/spring-security-authentication-unit-integration-tests' st_title='Spring Security Authentication in Unit / Integration tests' class='st_linkedin_hcount' displayText='LinkedIn'></span>
  <span st_url='http://tikalk.com/java/spring-security-authentication-unit-integration-tests' st_title='Spring Security Authentication in Unit / Integration tests' class='st_twitter_hcount' displayText='Tweet'></span>
  <span st_url='http://tikalk.com/java/spring-security-authentication-unit-integration-tests' st_title='Spring Security Authentication in Unit / Integration tests' class='st_fblike_hcount' displayText='Facebook Like'></span>
  <span st_url='http://tikalk.com/java/spring-security-authentication-unit-integration-tests' st_title='Spring Security Authentication in Unit / Integration tests' class='st_plusone_hcount' displayText='Google +1'></span>
</span>
</header>

                    <p>The problem (briefly) : I have a set of domain applications. These applications are managed by authorized personnel. I have to implement a sandbox approach: users (persistence) actions are supposed to be isolated from each other. I have to support the notation of optimistic locking: if two sandbox users try to update the same item, each changes are maintained in isolation and a first commit wins policy must be enforced. Finders method return subset or superset of domain object collections and authorization policies should be enforced over business components and methods.</p>

<p>&nbsp;</p>

<p>This article assumes basic knowledge of Spring Security concepts and API.</p>

<p>&nbsp;</p>

<p>First I had to think of how would a sandbox identity can be maintained and carried throughout the application. This came up very easy: since I use Spring security for ... security, I just added a sandbox identifier to authenticated Principals, which can be propagated and used by the security Context.</p>

<p>&nbsp;</p>

<pre title="code" class="brush: java;">
public class SandBoxUser extends org.springframework.security.core.userdetails.User {

    private Integer sandBox;

    public SandBoxUser
            (String username, String password, boolean enabled, Integer sandBox,
             Collection&lt;? extends org.springframework.security.core.GrantedAuthority&gt; authorities)

    {
        super(username, password, enabled, true, true, true, authorities);
        this.sandBox = sandBox;
    }

    public Integer getSandBox() {
          return sandBox;
    }

}</pre>

<p>&nbsp;</p>

<p>Fairly simple. A User class with an integer sandbox identity. I wouldn't get into details of how I've implemented the sandbox functionality in order to address the problems I've mentioned above, but briefly: I've used traditional mechanisms like AOP&nbsp;(which I'm controversial about), and Spring Security features like : @Secured, @PreAuthorize, and @PostFilter</p>

<p>&nbsp;</p>

<p>For example:</p>

<p>&nbsp;</p>

<pre title="code" class="brush: java;">
@Repository
@Secured(&quot;ROLE_SB&quot;)
public class SendBoxAssetDao {
...
}</pre>

<p>&nbsp;</p>

<p>Meaning that the DAO methods can only be accessed by users who are granted the ROLE_SB role.</p>

<p>&nbsp;</p>

<p>Also:</p>

<p>&nbsp;</p>

<pre title="code" class="brush: java;">
@Override
@PreAuthorize(&quot;#sandBoxAsset.sandBox == principal.sandBox&quot;)
public void persist(SandBoxAsset sandBoxAsset) {
        ...
}</pre>

<p>&nbsp;</p>

<p>Meaning that this method can only accessed once the following permission evaluates to true : the method argument sandbox property equals the predefined evaluated expression principal sandbox property. The principal is of type SandBoxUser from above. How to wire all this, we'll see in a minute.</p>

<p>&nbsp;</p>

<p>I've started the article by describing my problem. Well, I've a little bit cheated. The issues here, for those of you still following, is how to use all these authorization controls in conjunction with integration tests, where we don't have an authentication mechanism such as a login form. This is, as we shall soon see, is not complicated either.</p>

<p>&nbsp;</p>

<p>The first step is to mock a security domain for users and roles. We'll start by showing the security context (securityContext.xml) config file:</p>

<p>&nbsp;</p>

<pre title="code" class="brush: java;">
&lt;global-method-security pre-post-annotations=&quot;enabled&quot; secured-annotations=&quot;enabled&quot;/&gt;

&lt;authentication-manager&gt;
        &lt;authentication-provider user-service-ref=&quot;userDetailsService&quot;/&gt;
&lt;/authentication-manager&gt;

&lt;beans:bean id=&quot;userDetailsService&quot; class=&quot;com.xxx.security.spring.AssetManagerUserDetailsService&quot;/&gt;</pre>

<p>&nbsp;</p>

<p>We enable Spring security pre-post annotaions (such as @PreAuthorize) and secured annotation. This one would fit our production system as well. Next we declare the authentication manager to have a mock user detail service. Let have a look at it:</p>

<p>&nbsp;</p>

<pre class="brush: java;" title="code">
public class AssetManagerUserDetailsService implements UserDetailsService {

    Map&lt;String, Integer&gt; users = new HashMap&lt;String, Integer&gt;(2);
    {
        users.put(&quot;ori&quot;, 0);
        users.put(&quot;ofer&quot;, 1);
    }
    HashSet&lt;GrantedAuthority&gt; roles = Sets.&lt;GrantedAuthority&gt;newHashSet(new GrantedAuthorityImpl(&quot;ROLE_SB&quot;));

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException, DataAccessException {
        return new SandBoxUser(username, username, true, users.get(username), roles);
    }
}</pre>

<p>&nbsp;</p>

<p>Indeed, not a very clever one, but serves out purpose: we create a sandbox user with the Sandbox identifier we retrieve from the map, using the username itself as a key.</p>

<p>&nbsp;</p>

<p>So, now for the authentication itself. How is it done using (Spring test context) integration tests?</p>

<p>The answer, not suprisingly, is using Spring Security:</p>

<p>&nbsp;</p>

<pre title="code" class="brush: java;">
@ContextConfiguration(locations = {&quot;/securityContext.xml&quot;})
public abstract class MockSecurityIntegrationTests extends AbstractTestNGSpringContextTests {

    Map&lt;Integer, String&gt; users = new HashMap&lt;Integer, String&gt;(2);
    {
        users.put(0, &quot;ori&quot;);
        users.put(1, &quot;ofer&quot;);
    }
    HashSet&lt;GrantedAuthority&gt; roles = Sets.&lt;GrantedAuthority&gt;newHashSet(new GrantedAuthorityImpl(&quot;ROLE_SB&quot;));

   @BeforeSuite
    public void authenticate() {
        int sb = new Random().nextBoolean() ? 1 : 0;
        String name = users.get(sb);
        SandBoxUser user = new SandBoxUser(name, name, true, sb, roles);
        UsernamePasswordAuthenticationToken token =  new UsernamePasswordAuthenticationToken(user, user.getPassword());
        SecurityContextHolder.getContext().setAuthentication(token);
    }
}</pre>

<p>&nbsp;</p>

<p>Again, we're using a map for mock values. Note however that the keys and values are flipped (compared to the authorization example). We create a sandbox user instance, pass it to a UsernamePasswordAuthenticationToken (which is basically a java.security.Principal) and authenticate it against security context. This is really how authentication is done. All the rest was just a sort of a preface.</p>

<p>&nbsp;</p>

<p>As a quick test we'll define an authorization dependent Spring service:</p>

<p>&nbsp;</p>

<pre title="code" class="brush: java;">
@Service
public class MockRoleBaseSecurityService {
    @Secured(&quot;ROLE_SB&quot;)
    public void allowedForSandBox() {
    }

    @Secured(&quot;ROLE_NOTEXIST&quot;)
    public void disallowedForSandBox() {
    }
}</pre>

<p>&nbsp;</p>

<p>We expect our sandbox user to pass through the first method invocation and be denied for the second one.</p>

<p>A simple test case can verify it:</p>

<p>&nbsp;</p>

<pre title="code" class="brush: java;">
public class RoleCheckIntegrationTests extends MockSecurityIntegrationTests {

    @Autowired
    MockRoleBaseSecurityService service;

    @Test
    public void allow() {
        service.allowedForSandBox();
    }

    @Test(expectedExceptions = {AccessDeniedException.class})
    public void deny() {
        service.disallowedForSandBox();
        fail(&quot;You're supposed to be unauthorized&quot;);   
    }

}</pre>

<p>&nbsp;</p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<p>&nbsp;</p>

                    <div class="fb-comments" data-href="http://tikalk.com/java/spring-security-authentication-unit-integration-tests" data-width="600px" data-numposts="5" data-colorscheme="light"></div>
                    <footer></footer>
                  </article>
                </div>
              </div>
            </div>
          </div>
        </div>
        <footer id="footer" role="contentinfo">
  <div class="region region-footer">
    <section id="block-block-2" class="block block-block block-about-tikal block-even">
      <h2 class="block-title">About Tikal</h2>

      <div class="content">
        <div>
          <div>
            For over 12 years, we have helped breakthrough companies achieve excellence and meet their goals.&nbsp;</div>
          <div>
            By doing so we've earned recognition for delivering extremely competitive and high-performance software services to clients worldwide.</div>
        </div>
        <div class="contact-title">
          Contact Information</div>
        <div class="contact-number">
          (972) 3 6488618</div>
        <div class="contact-mail">
          <a href="">info@tikalk.com</a></div>
      </div><!-- /.content -->
    </section><!-- /.block -->
    <section id="block-webform-client-block-22" class="block block-webform join-the-team block-odd">
      <h2 class="block-title">Join the Team</h2>
      <div class="content">
        <div>
          <div class="form-item webform-component webform-component-markup" id="webform-component-sub-header">
              <p>Let us contact you with more information</p>
          </div>
          <script type="text/javascript" src="http://form.jotform.me/jsform/41884289305463"></script>
        </div>
      </div><!-- /.content -->
    </section><!-- /.block -->
    <section id="block-general-tikal-map-home-page" class="block block-general-tikal block-even">
      <h2 class="block-title">Find us at:</h2>

      <div class="content">

        <div id="map_canvas_footer" style="width: 240px; height: 200px;"></div>
        <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
        <script type="text/javascript">
            var latlng = new google.maps.LatLng(32.1065469,34.83523969999999);
            var settings = {
            zoom: 15,
                  center: latlng,
                  mapTypeControl: false,
                  mapTypeControlOptions: {style: google.maps.MapTypeControlStyle.DROPDOWN_MENU},
                  navigationControlOptions: {style: google.maps.NavigationControlStyle.SMALL},
                  mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            var map = new google.maps.Map(document.getElementById("map_canvas_footer"), settings);      
            var companyImage = new google.maps.MarkerImage("/assets/icons/logo-map-1a2609d2dd636172949b30cd33a1d8a0.png",
                new google.maps.Size(100,50),
                new google.maps.Point(0,0),
                new google.maps.Point(50,50)
            );
            var companyShadow = new google.maps.MarkerImage("images/logo_shadow.png",
                new google.maps.Size(130,50),
                new google.maps.Point(0,0),
                new google.maps.Point(65, 50)
            );
            var companyPos = new google.maps.LatLng(32.1065469,34.83523969999999);
            var companyMarker = new google.maps.Marker({
              position: companyPos,
              map: map,
              icon: companyImage,
              shadow: companyShadow,
              title:"",
              zIndex: 3}
            );
        </script>  
      </div><!-- /.content -->
    </section><!-- /.block -->
    <div id="block-block-3" class="block block-block find-us-at block-odd">
      <div class="content">
        <div class="address">
          Habarzel 4 st, 1st Floor&nbsp;<br>
          Tel Aviv 69710<br>
          Israel
        </div>  
      </div><!-- /.content -->
    </div><!-- /.block -->
  </div>
</footer>

        <footer id="footer-second" role="contentinfo">
  <div class="region region-footer-second">
    <section id="block-views-popular-articles-block" class="block block-views block-even">
      <h2 class="block-title">Popular Articles</h2>

      <div class="content">
        <div class="view view-popular-articles view-id-popular_articles view-display-id-block view-dom-id-796319b1b70c397287cdccd16eebbb82">

          <div class="view-content">
            <div class="view-content-limit">
              <div class="view-content-limit-content">
                <div class="views-row views-row-1 views-row-odd views-row-first">

                  <div class="views-field views-field-title">        <span class="field-content"><a href="/java/location-auto-complete-and-lookup">Location Auto complete and lookup</a></span>  </div>  </div>
                <div class="views-row views-row-2 views-row-even">

                  <div class="views-field views-field-title">        <span class="field-content"><a href="/js/present-and-future-typescript">Present and future of TypeScript</a></span>  </div>  </div>
                <div class="views-row views-row-3 views-row-odd views-row-last">

                  <div class="views-field views-field-title">        <span class="field-content"><a href="/ror/building-gogobot-social-graph">building the gogobot social graph</a></span>  </div>  </div>
              </div>
            </div>
          </div>

      </div>  </div><!-- /.content -->
    </section><!-- /.block -->
    <section id="block-menu-menu-fields" class="block block-menu block-odd">
      <h2 class="block-title">Domains</h2>

      <div class="content">
        <ul class="menu clearfix"><li class="first leaf application lifecycle management"><a href="/alm" title="">DevOps</a></li>
          <li class="leaf java"><a href="/java" title="">Java</a></li>
          <li class="leaf javascript"><a href="/js" title="">JavaScript</a></li>
          <li class="leaf .net"><a href="/net" title="">Android</a></li>
          <li class="last leaf ruby on rails"><a href="/ror" title="">Ruby</a></li>
      </ul>  </div><!-- /.content -->
    </section><!-- /.block -->
    <section id="block-menu-menu-site-map" class="block block-menu block-even">
      <h2 class="block-title">Site Map</h2>

      <div class="content">
        <ul class="menu clearfix"><li class="first leaf about us"><a href="/about" title="">About Us</a></li>
          <li class="leaf active-trail solutions"><a href="/solutions" title="" class="active-trail active">Solutions</a></li>
          <li class="leaf careers"><a href="/careers" title="">Careers</a></li>
          <li class="leaf events"><a href="/events" title="">Events</a></li>
          <li class="last leaf contact"><a href="/contact" title="">Contact</a></li>
      </ul>  </div><!-- /.content -->
    </section><!-- /.block -->
    <div id="block-block-1" class="block block-block all-rights-reserved block-odd">

      <div class="content">
        <p>© 2013 All Rights Reserved. Tikal</p>
      </div><!-- /.content -->
    </div><!-- /.block -->
    <div id="block-menu-menu-external-links" class="block block-menu block-even">

      <div class="content">
        <ul class="menu clearfix"><li class="first leaf facebook"><a href="http://www.facebook.com/TikalKnowledge" title="" target="_blank">Facebook</a></li>
          <li class="leaf twitter"><a href="https://twitter.com/TikalK" title="" target="_blank">Twitter</a></li>
          <li class="leaf in"><a href="http://www.linkedin.com/company/tikal-knowledge" title="" target="_blank">in</a></li>
          <li class="last leaf rss"><a href="/rss-latest-articles" title="Latest Articles">RSS</a></li>
      </ul>  </div><!-- /.content -->
    </div><!-- /.block -->
  </div>
</footer>

    </body>
</html>
