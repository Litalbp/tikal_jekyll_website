<!DOCTYPE html>
<html>
    <head>
      <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>Load a tree with JPA and Hibernate</title>
<meta name="viewport" content="width=device-width">
<link rel="shortcut icon" href="favicon.ico" type="image/vnd.microsoft.icon" />
<!-- syntax highlighting CSS -->
<!--link rel="stylesheet" href="/css/syntax.css"-->

<!-- Custom CSS -->
<link rel="stylesheet" href="/assets/application-1070e5396a9f348b2c31565a8ca2ade6.css">

<!-- Custom JS -->
<script src="/assets/vendor/jquery-2.1.1-fbf0c31ef61d80bbbc98a9cdfc7e6632.js"></script>
<script src="/assets/vendor/jquery.validate-466ee815d7a2fb9b74b895b6a0f9551c.js"></script>
<script src="/assets/vendor/scrollup/jquery.scrollUp-d730604bacd24a59da00d38b42cd77af.js"></script>
<script src="/assets/vendor/drupal_legacy-d5580e3eaf6de5a1446255d180dc73d3.js"></script>
<script src="/assets/vendor/angular.min-dfd2efe0eaac3581c5faf5cfed3b159e.js"></script>
<script src="/assets/meetup_events-5782f731b79266fd93b159cb798cc3d5.js"></script>
<script src="/assets/contact-897905f16738b8c5c1688eefae319441.js"></script>
<script src="/assets/application-07f972327fcb4602f91f1e8ba4b78498.js"></script>

<!-- ShareThis JS for posts section -->
<script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
<script type="text/javascript">stLight.options({publisher: "6ae64a50-63a5-4021-a8de-b0adce0ce99b", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    </head>

    <body class="one-sidebar sidebar-second section-java page-node node-type-article all-pages with-navigation with-subnav featured dir-ltr">
        <div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&appId=519865898033052&version=v2.0";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
        <div id="header-first">
  <div class="region region-header-first">
    <div id="block-search-form" class="block block-search block-odd">

      <div class="content">
        <form id="search-block-form" accept-charset="UTF-8"><div><div class="container-inline">
              <h2 class="element-invisible">Search form</h2>
              <div class="form-item form-type-textfield form-item-search-block-form">
                <label class="element-invisible" for="edit-search-block-form--2">Search </label>
                <input title="Enter the terms you wish to search for." placeholder="Search" type="search" id="edit-search-block-form--2" name="search_block_form" value="" size="15" maxlength="128" class="form-text">
              </div>
              <div class="form-actions form-wrapper" id="edit-actions"><input type="submit" id="edit-submit" name="op" value="Search" class="form-submit"></div><input type="hidden" name="form_build_id" value="form-hCEJ23kB0sHlr4dB3Yv5-2cDcH10yNwGSUn69WjCjF4">
              <input type="hidden" name="form_id" value="search_block_form">
            </div>
      </div></form>  </div><!-- /.content -->
    </div><!-- /.block -->
    <div id="block-menu-menu-top-links" class="block block-menu block-even">

      <div class="content">
        <ul class="menu clearfix"><li class="first last leaf login"><a href="/user" title="">login</a></li>
      </ul>  </div><!-- /.content -->
    </div><!-- /.block -->
    <div id="block-menu-menu-language" class="block block-menu block-odd">
      
      <div class="content">
        <ul class="menu clearfix"><li class="first last leaf עברית"><a href="/hebrew" title="">עברית</a></li>
      </ul>  </div><!-- /.content -->
    </div><!-- /.block -->
  </div>
</div>
<div id="google-search-form" style="visibility:hidden; width: 1px; height: 1px; float:right;">
  <script>

    (function() {
        var cx = '012617499894110201007:qu0yvmmzksu';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = false;
        gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
                '//www.google.com/cse/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
    })();
</script>
<gcse:searchresults-only linkTarget="_self"></gcse:searchresults-only>


<script>
    $(document).ready(function() {
        $('#search-block-form').submit(function (e) {
            e.preventDefault();

            //find google search form
            var form = $('.gsc-control-wrapper-cse').find('form');
            var input = form.find("input[name='search']");
            var btn = form.find("input[type='image']");
            var tikalSearch = $('#edit-search-block-form--2');
            tikalSearch.blur();
            $("#bg").show();
            input.val(tikalSearch.val());
            //form.submit();
            btn.click();

        });
        
    });


</script>

</div>

        <header id="header" role="banner">
  <div class="logo-and-region-header">
    <div class="background-logo"></div>
    <a href="/" title="Home" rel="home" id="logo">
      <img src="/assets/logo-ebc269c722e9e1e11b3252c442c75750.png" alt="Home">
    </a>


    <div class="region region-header">
      <section id="block-menu-menu-header-menu" class="block block-menu block-even">
        <h2 class="block-title element-invisible">Header menu</h2>

        <div class="content">
          <ul class="menu clearfix">
            
              
              <li class="leaf"><a href="/about" class="">About</a></li>
            
              
              <li class="leaf"><a href="/solutions" class="">Solutions</a></li>
            
              
              <li class="leaf"><a href="/careers" class="">Careers</a></li>
            
              
              <li class="leaf"><a href="/events" class="">Events</a></li>
            
              
              <li class="leaf"><a href="/contact" class="">Contact</a></li>
            
        </ul>  </div><!-- /.content -->
      </section><!-- /.block -->
      <section id="block-menu-menu-domains" class="block block-menu block-odd">
        <h2 class="block-title element-invisible">Domains</h2>

        <div class="content">
          <ul class="menu clearfix"><li class="first leaf devops"><a href="/devops" title="">DevOps</a></li>
            <li class="leaf java"><a href="/java" title="">JAVA</a></li>
            <li class="leaf js"><a href="/js" title="">JS</a></li>
            <li class="leaf android"><a href="/android" title="">Android</a></li>
            <li class="last leaf ruby"><a href="/ruby" title="">Ruby</a></li>
        </ul>  </div><!-- /.content -->
      </section><!-- /.block -->
    </div>
  </div><!-- /#logo-and-region-header -->
</header>

        <div class="featured-background">
  <div id="featured">
    <div class="region-title-and-featured">
      <h1 class="title" id="page-title">Load a tree with JPA and Hibernate</h1>
      <div class="region region-featured">
        <div id="block-views-author-block" class="block block-views">
          <div class="content">
            <div class="view view-author view-id-author view-display-id-block">
  <div class="view-content">
    <div class="view-content-limit">
      <div class="view-content-limit-content">
        <div class="views-row">
          <div class="views-field views-field-picture">
            <div class="field-content">
              
                <img typeof="foaf:Image" src="/assets/pictures/picture-51-1361228853-03465e84095f1b341f59ad57fcb5e142.jpg" width="307" height="230" alt="">
              
            </div>  
          </div>
          <div class="views-field views-field-field-first-name">
            <div class="field-content">Yanai</div>
          </div>
          <div class="views-field views-field-field-last-name">
            <div class="field-content">Franchi</div>
          </div>
          <div class="views-field views-field-field-description">
            <div class="field-content">Java Architect</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

        <div class="shadow-page"></div>
        <div id="page">
          <div id="main">
            <div class="region region-content">
              <div id="block-system-main" class="block block-system">
                <div class="content">
                  <article class="node node-article published with-comments node-full">
                    <header>
  <div class="by-and-tags">
    <div class="by">
      <div class="label-by">by</div>
      <div class="name">
        <a href='/java/yanai'>yanai</a>
      </div>
    </div>
    <div class="tags">
      <div class="label-tags">tags:</div>
      <div class="float-tags">
        <div class="field field-name-field-tags field-type-taxonomy-term-reference field-label-hidden clearfix">
          <ul class="links">
            
              <li>
                <a href="/tags/JAVA">JAVA</a>
              </li>
            
              <li>
                <a href="/tags/Tree-JPA-Hibernate">Tree JPA Hibernate</a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
  <time pubdate="" datetime="2010-09-26 00:00:00 +0200">
        <div class="day">26</div>
        Sep. 2010
      </time>
  
  
  


<span class="share-buttons">
  <span st_url='http://tikalk.com/java/load-tree-jpa-and-hibernate' st_title='Load a tree with JPA and Hibernate' class='st_facebook_hcount' displayText='Facebook'></span>
  <span st_url='http://tikalk.com/java/load-tree-jpa-and-hibernate' st_title='Load a tree with JPA and Hibernate' class='st_linkedin_hcount' displayText='LinkedIn'></span>
  <span st_url='http://tikalk.com/java/load-tree-jpa-and-hibernate' st_title='Load a tree with JPA and Hibernate' class='st_twitter_hcount' displayText='Tweet'></span>
  <span st_url='http://tikalk.com/java/load-tree-jpa-and-hibernate' st_title='Load a tree with JPA and Hibernate' class='st_fblike_hcount' displayText='Facebook Like'></span>
  <span st_url='http://tikalk.com/java/load-tree-jpa-and-hibernate' st_title='Load a tree with JPA and Hibernate' class='st_plusone_hcount' displayText='Google +1'></span>
</span>
</header>

                    <p>Every now and again I go to a Tikal customer, who needs to model hierarchical data structure for his domain model. The hierarchy can be a department hierarchy, a category hierarchy , a geographic hierarchy, or any other hierarchy you can think of, that might be needed by the customer. Usually this hierarchy is modeled by a <a href="http://en.wikipedia.org/wiki/Tree_%28data_structure%29">Tree Data Structure</a>. <br />
There are a few implementation variants for the tree data-structure in Java. Lets have a look at a very basic implementation using a class named &ldquo;Node&rdquo;. The &ldquo;Node&rdquo; class can be easily mapped to a table named &ldquo;tree&rdquo; in the DB. This table contains all nodes objects in the tree. The table will have a foreign key from each node record to its parent node's id (the primary key in the table) using a field called &ldquo;parent_id&rdquo;. The &ldquo;Node&quot; entity has a property called &ldquo;children&rdquo; - a <a href="http://en.wikibooks.org/wiki/Java_Persistence/Relationships#Order_Column_.28JPA_2.0.29">persistent ordered list</a> (assuming there is meaning for the children order) of child Nodes, a new feature in JPA 2. We map the join column &ldquo;parent_id&rdquo; for the children association. Here is sample of the &ldquo;Node&rdquo; entity Java class: <br />
&nbsp;</p>

<pre class="brush: java;" title="code">

</pre>

<pre class="brush: java;" title="code">
@Entity 
@Table(name = &quot;tree&quot;) 
public class Node { 

    @Id 
    @GeneratedValue 
    private Integer id; 

    @NotNull 
    private String name; 

    @OneToMany 
    @JoinColumn(name = &quot;parent_id&quot;) 
    @OrderColumn
    private List&lt;Node&gt; children = new LinkedList&lt;Node&gt;(); 

    ... 
} </pre>

<h1>&nbsp;</h1>

<h1>The Problem</h1>

<p>What is the best way to load the tree per end-use request? <br />
<br />
Lets assume for our discussion, the tree is not huge, less than a few hundreds of nodes, and you really need to load it all (this is also a valuable question). A naive approach, is to load the tree's root node, and then traverse its descendants. <br />
The problem with this attitude, it will create N queries on a tree with N nodes -&nbsp; For each and every node in the tree, Hibernate will issue an SQL that fetches the node children. <br />
<br />
So is there a better way to load the whole tree, and avoid these N queries ?</p>

<p>&nbsp;</p>

<h1>The Solution</h1>

<p>Luckily, there is a better way...<br />
We can take advantage of the JPA's persistence context (part of the JPA spec). When we issue a query that loads all nodes with their children, all nodes are loaded into the JPA persistence context. Actually, the same node can be loaded either as a parent, a child or both. However, the JPA spec requires that the same entity instance will exist only once in the same persistence context, Thus both references will point to the same instance. The result is that we get the whole hierarchy interrelated. Last thing we need to do, is loading the root category, which will be loaded from the persistence context rather than the DB since it was loaded with all nodes in the query. <br />
<br />
So our data access method to load the whole tree remains simple. Lets have a look on it:</p>

<pre class="brush: java;" title="code">
public Node getTree(){ 
  entityManager.createNamedQuery
    (&quot;findAllNodesWithTheirChildren&quot;).getResultList(); 
   Node root = entityManager.find(Node.class, ROOT_ID); 
   return root;
} </pre>

<p>&nbsp;</p>

<p>Here is the explanation for the code above: <br />
The injected entityManager is been used with JPA in our DAO class. The ROOT_ID is a constant that holds the id for the root category in an application cache. We can see that our method contains only two lines to get the whole tree.<br />
The first line uses a named query called&nbsp; &ldquo;findAllNodesWithTheirChildren&rdquo;. This query loads all nodes from the DB with left join fetch of their children. <br />
Here is the named query implementation for our needs: <br />
select n from Node n left join fetch n.children <br />
<br />
Please note we are not making explicit use of the result list in our method above. The usage is done implicitly, since all nodes are automatically loaded into the persistence context.<br />
<br />
The second line just loads the root node. Since the root node has already been entered the persistence context (due to the first line), there will be no extra select for the root. <br />
&nbsp;</p>

<h1>Working With Bidirectional Tree</h1>

<p>Another use case is when we have the tree built from nodes with parent-child bi-directional association. In this case, we have both association from parent node to its children, and we also have a reverse association from the child to the parent. Since we have a bi-directional association with index column (to preserve the order of the children in the list), we can either map the index column. Another option is to make the OneToMany-side the owning side by removing the &quot;mappedBy&quot; element and setting the @JoinColumn on the ManyToOne-side as &quot;insertable=false&quot; and &quot;updateable=false&quot;.</p>

<p>I chose to do the second option. Here is the code with the added association named &ldquo;parent&rdquo;:</p>

<pre class="brush: java;" title="code">
@Entity
@Table(name = &quot;tree&quot;)
public class Node {

    @Id
    @GeneratedValue
    private Integer id;

    @NotNull
    private String name;

    @OneToMany
    @OrderColumn
    @JoinColumn(name = &quot;parent_id&quot;)
    private List&lt;Node&gt; children = new LinkedList&lt;Node&gt;();
    
    @ManyToOne(fetch=FetchType.LAZY)
    @JoinColumn(name = &quot;parent_id&quot;,insertable=false,updatable=false)
    private Node parent;

    &hellip;
}</pre>

<p>&nbsp;</p>

<p>Assuming we want to use the same trick of loading all nodes, Should we change our query, by adding a fetch join for &ldquo;parent&rdquo; association ? The answer is &hellip; NO!.<br />
The reason we should NOT apply fetch query on the parent (even-though its declared as lazy) is because &ldquo;parent&rdquo; association is been initialized automatically without extra selects - All nodes are loaded in the query and , when they are loaded the children nodes &ldquo;parent&rdquo; association are been initialized. For this reason the query should be remained as is with fetch join to the children only.</p>

<p>&nbsp;</p>

<h1>Summary</h1>

<p>We are done now &ndash; We ended with only one select that loads the whole tree (all N nodes are been loaded) instead of N selects. This is true with either unidirectional or bidirectional tree, and when we changed our mapping to be bidirectional, we didn't change the query that loads the tree.<br />
Obviously the second option of loading all the nodes with query runs in order of magnitude faster. <br />
Of course, if the tree is read mostly, its also&nbsp; strongly recommended to use the 2nd level cache, and we can spare the single select to the DB per each end user request.</p>

                    <div class="fb-comments" data-href="http://tikalk.com/java/load-tree-jpa-and-hibernate" data-width="600px" data-numposts="5" data-colorscheme="light"></div>
                    <footer></footer>
                  </article>
                </div>
              </div>
            </div>
          </div>
        </div>
        <footer id="footer" role="contentinfo">
  <div class="region region-footer">
    <section id="block-block-2" class="block block-block block-about-tikal block-even">
      <h2 class="block-title">About Tikal</h2>

      <div class="content">
        <div>
          <div>
            For over 12 years, we have helped breakthrough companies achieve excellence and meet their goals.&nbsp;</div>
          <div>
            By doing so we've earned recognition for delivering extremely competitive and high-performance software services to clients worldwide.</div>
        </div>
        <div class="contact-title">
          Contact Information</div>
        <div class="contact-number">
          (972) 3 6488618</div>
        <div class="contact-mail">
          <a href="">info@tikalk.com</a></div>
      </div><!-- /.content -->
    </section><!-- /.block -->
    <section id="block-webform-client-block-22" class="block block-webform join-the-team block-odd">
      <h2 class="block-title">Join the Team</h2>
      <div class="content">
        <div>
          <div class="form-item webform-component webform-component-markup" id="webform-component-sub-header">
              <p>Let us contact you with more information</p>
          </div>
          <script type="text/javascript" src="http://form.jotform.me/jsform/41884289305463"></script>
        </div>
      </div><!-- /.content -->
    </section><!-- /.block -->
    <section id="block-general-tikal-map-home-page" class="block block-general-tikal block-even">
      <h2 class="block-title">Find us at:</h2>

      <div class="content">

        <div id="map_canvas_footer" style="width: 240px; height: 200px;"></div>
        <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
        <script type="text/javascript">
            var latlng = new google.maps.LatLng(32.1065469,34.83523969999999);
            var settings = {
            zoom: 15,
                  center: latlng,
                  mapTypeControl: false,
                  mapTypeControlOptions: {style: google.maps.MapTypeControlStyle.DROPDOWN_MENU},
                  navigationControlOptions: {style: google.maps.NavigationControlStyle.SMALL},
                  mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            var map = new google.maps.Map(document.getElementById("map_canvas_footer"), settings);      
            var companyImage = new google.maps.MarkerImage("/assets/icons/logo-map-1a2609d2dd636172949b30cd33a1d8a0.png",
                new google.maps.Size(100,50),
                new google.maps.Point(0,0),
                new google.maps.Point(50,50)
            );
            var companyShadow = new google.maps.MarkerImage("images/logo_shadow.png",
                new google.maps.Size(130,50),
                new google.maps.Point(0,0),
                new google.maps.Point(65, 50)
            );
            var companyPos = new google.maps.LatLng(32.1065469,34.83523969999999);
            var companyMarker = new google.maps.Marker({
              position: companyPos,
              map: map,
              icon: companyImage,
              shadow: companyShadow,
              title:"",
              zIndex: 3}
            );
        </script>  
      </div><!-- /.content -->
    </section><!-- /.block -->
    <div id="block-block-3" class="block block-block find-us-at block-odd">
      <div class="content">
        <div class="address">
          Habarzel 4 st, 1st Floor&nbsp;<br>
          Tel Aviv 69710<br>
          Israel
        </div>  
      </div><!-- /.content -->
    </div><!-- /.block -->
  </div>
</footer>

        <footer id="footer-second" role="contentinfo">
  <div class="region region-footer-second">
    <section id="block-views-popular-articles-block" class="block block-views block-even">
      <h2 class="block-title">Popular Articles</h2>

      <div class="content">
        <div class="view view-popular-articles view-id-popular_articles view-display-id-block view-dom-id-796319b1b70c397287cdccd16eebbb82">

          <div class="view-content">
            <div class="view-content-limit">
              <div class="view-content-limit-content">
                <div class="views-row views-row-1 views-row-odd views-row-first">

                  <div class="views-field views-field-title">        <span class="field-content"><a href="/java/location-auto-complete-and-lookup">Location Auto complete and lookup</a></span>  </div>  </div>
                <div class="views-row views-row-2 views-row-even">

                  <div class="views-field views-field-title">        <span class="field-content"><a href="/js/present-and-future-typescript">Present and future of TypeScript</a></span>  </div>  </div>
                <div class="views-row views-row-3 views-row-odd views-row-last">

                  <div class="views-field views-field-title">        <span class="field-content"><a href="/ror/building-gogobot-social-graph">building the gogobot social graph</a></span>  </div>  </div>
              </div>
            </div>
          </div>

      </div>  </div><!-- /.content -->
    </section><!-- /.block -->
    <section id="block-menu-menu-fields" class="block block-menu block-odd">
      <h2 class="block-title">Domains</h2>

      <div class="content">
        <ul class="menu clearfix"><li class="first leaf application lifecycle management"><a href="/alm" title="">DevOps</a></li>
          <li class="leaf java"><a href="/java" title="">Java</a></li>
          <li class="leaf javascript"><a href="/js" title="">JavaScript</a></li>
          <li class="leaf .net"><a href="/net" title="">Android</a></li>
          <li class="last leaf ruby on rails"><a href="/ror" title="">Ruby</a></li>
      </ul>  </div><!-- /.content -->
    </section><!-- /.block -->
    <section id="block-menu-menu-site-map" class="block block-menu block-even">
      <h2 class="block-title">Site Map</h2>

      <div class="content">
        <ul class="menu clearfix"><li class="first leaf about us"><a href="/about" title="">About Us</a></li>
          <li class="leaf active-trail solutions"><a href="/solutions" title="" class="active-trail active">Solutions</a></li>
          <li class="leaf careers"><a href="/careers" title="">Careers</a></li>
          <li class="leaf events"><a href="/events" title="">Events</a></li>
          <li class="last leaf contact"><a href="/contact" title="">Contact</a></li>
      </ul>  </div><!-- /.content -->
    </section><!-- /.block -->
    <div id="block-block-1" class="block block-block all-rights-reserved block-odd">

      <div class="content">
        <p>© 2013 All Rights Reserved. Tikal</p>
      </div><!-- /.content -->
    </div><!-- /.block -->
    <div id="block-menu-menu-external-links" class="block block-menu block-even">

      <div class="content">
        <ul class="menu clearfix"><li class="first leaf facebook"><a href="http://www.facebook.com/TikalKnowledge" title="" target="_blank">Facebook</a></li>
          <li class="leaf twitter"><a href="https://twitter.com/TikalK" title="" target="_blank">Twitter</a></li>
          <li class="leaf in"><a href="http://www.linkedin.com/company/tikal-knowledge" title="" target="_blank">in</a></li>
          <li class="last leaf rss"><a href="/rss-latest-articles" title="Latest Articles">RSS</a></li>
      </ul>  </div><!-- /.content -->
    </div><!-- /.block -->
  </div>
</footer>

    </body>
</html>
